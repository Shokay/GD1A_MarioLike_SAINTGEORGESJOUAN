<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" /><title>Mon 1er jeu Phaser</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.js">
    </script>

    <style type="text/css"> body 
    
        { margin: 0; 
        }
        
    
    </style>
</head>
<body>
    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            width: 1280, height: 720,
            physics: {
            default: 'arcade',
            arcade: {
            gravity: { y: 1500},
            debug: false
            }},
            pixelArt: true,
            scene: {preload: preload, create: create, update: update }
            };

        new Phaser.Game(config);
        

        function preload(){
            //load de toute les images / sprites sheet 

            this.load.image("Phaser_tuilesdejeu", "assets/tilesetproto.png");
            this.load.image("persoP","assets/persoproto.png");
            this.load.image("blocVide", "assets/blocV.png");
       
            this.load.tilemapTiledJSON("carte", "MapProto.json");  

            this.load.spritesheet('AnimTestP','assets/SpriteSheetPersoTest.png',
                { frameWidth: 32, frameHeight: 32 });

        }

            
        // Initialisation des var    
        var player;
        var cursors;
        var startgGame=true;
        var valdash = 0;
        var indash = false;
        var validDash = false;
        var compteur = 30;
        var compteur2 = 0;
        var verifValid = 0;
        var FpressVerif = false;
        var dashstart= false;
        var dash2 = true;
        var dashvalmax=false;
        var compteurMax = 20;
        var colorAppliqué=false;
        var startFall = false;
        var compteurF = 30;
        var fallVerif=false;
        var fdown = this.keys.f.isUp;
        var isfallin=false;
        var injump=false;
        var isDownM = false;
        var mouseX = 0;
        var mouseY = 0;

        function create (){
            
            const carteDuNiveau = this.add.tilemap("carte");

            // importer TileSet 
            const tileset = carteDuNiveau.addTilesetImage(
                    "tilesetproto",
                    "Phaser_tuilesdejeu"
                    );        
            

            // importer les calques 


            const FondNiveau = carteDuNiveau.createLayer(
                    "background",
                    tileset
                    ); 

            const plateformes = carteDuNiveau.createLayer(
                    "plateformeP",
                    tileset
                    ); 

            player = this.physics.add.sprite(1830,2504, 'persoP');            //init joueur
            player.body.setSize(24,18,true)        
            player.setOffset(5, 13)
            player.alpha = 1; 

            blocG = this.physics.add.staticGroup();

            plateformes.setCollisionByProperty({ estSolide: true });   
            this.physics.add.collider(player, plateformes);
            player.setCollideWorldBounds(true);
            this.physics.add.collider(player,blocG)
            
            carteDuNiveau.getObjectLayer('Physic').objects.forEach((bloc) => {
                    const blocsprite = blocG.create(bloc.x+=16 , bloc.y -= 16, "blocVide").setOrigin(0);               //importation via calque objet feu de camp
            });

            this.physics.world.setBounds(0, 0, 3200, 2560);
            this.cameras.main.setBounds(0, 0, 3200,2560);
            this.cameras.main.zoom = 2;                  //Camera
            this.cameras.main.startFollow(player); 
            
            this.anims.create({
                    key: 'WalkR',           
                    frames: this.anims.generateFrameNumbers('AnimTestP', {start:0,end:2}),          //creation des animation
                    frameRate: 5,
                    repeat: -1,
                });  

            this.anims.create({
                    key: 'WalkL',           
                    frames: this.anims.generateFrameNumbers('AnimTestP', {start:3,end:5}),          //creation des animation
                    frameRate: 5,
                    repeat: -1,
                }); 
                
            this.anims.create({
                    key: 'Immobile',           
                    frames: this.anims.generateFrameNumbers('AnimTestP', {start:6,end:8}),          //creation des animation
                    frameRate: 5,
                    repeat: -1,
                }); 

            this.anims.create({
                    key: 'Jump',           
                    frames: this.anims.generateFrameNumbers('AnimTestP', {start:9,end:12}),          //creation des animation
                    frameRate: 10,
                }); 

            this.anims.create({
                    key: 'fall',           
                    frames: this.anims.generateFrameNumbers('AnimTestP', {start:13,end:14}),          //creation des animation
                    frameRate: 5,
                    repeat: -1,
                }); 

            this.input.on('pointerdown', function(pointer) {
                isDownM = true
                mouseX = pointer.x 
                mouseY = pointer.y 
            });
            this.input.on('pointermove', function(pointer) {
                mouseX = pointer.x 
                mouseY = pointer.y 
            });
            this.input.on('pointerup', function(pointer) {
                isDownM = false
            });

            // touches clavier
            cursors = this.input.keyboard.createCursorKeys();
            this.keys = this.input.keyboard.addKeys({
                q:  Phaser.Input.Keyboard.KeyCodes.Q,
                d:  Phaser.Input.Keyboard.KeyCodes.D,
                s:  Phaser.Input.Keyboard.KeyCodes.S,
                z:  Phaser.Input.Keyboard.KeyCodes.Z,
                a:  Phaser.Input.Keyboard.KeyCodes.A,
                e:  Phaser.Input.Keyboard.KeyCodes.E,               //importation de touche
                f:  Phaser.Input.Keyboard.KeyCodes.F,
                espace:  Phaser.Input.Keyboard.KeyCodes.SPACE
            });
        }
        function update(){
            console.log(mouseX)
            console.log(mouseY)
            fdown = this.keys.f.isUp;
            
            if (player.body.blocked.down || player.body.blocked.left || player.body.blocked.right){
                FpressVerif=false;
                compteur=30;
                valdash=0;
                dashvalmax=false;
                colorAppliqué=false;
                fdown = this.keys.f.isUp;
            }

            if (player.body.blocked.down){
                dash2 = true;
                indash = false;
                fallVerif=false;
                injump=false;z
            }

            if(dash2==true){
            if (this.keys.f.isDown && fallVerif==false){
                    player.setVelocityX(0)
                    player.setVelocityY(-25);
                    FpressVerif = true;
                    valdash+=1
            }
            }

            if (valdash>=100){
                valdash=100;
                dashvalmax=true;
            }

            if (dashvalmax == true && colorAppliqué==false){
                    player.setTintFill(0xffffff);
                    compteurMax --
            }

            if (compteurMax==0){
                compteurMax=20
                player.setTint(0xffffff);
                colorAppliqué=true;
                startFall = true;
            }

            if (isDownM==true){
                console.log("yo")
                player.setVelocityY(mouseY);
                player.setVelocityX(mouseX);
            }

            if(startFall == true){
                compteurF--
                if (compteurF==0){
                    fallVerif=true;
                    compteurF=30;
                    startFall=false;
                }
            }

            if(indash==true){
                fallVerif=false;
                fdown = this.keys.f.isUp ||this.keys.f.isDown;
            }
            
            if(fdown && FpressVerif == true && fallVerif==false){
                compteur--
                indash = true;
                dash2 = false;
                if (player.direction=="gauche"){
                    player.setVelocityX(-(valdash*10))
                    player.setVelocityY(-25);
                }
                if (player.direction=="droite"){
                    player.setVelocityX(valdash*10);
                    player.setVelocityY(-25);
                }
                if (compteur==0 ){
                    FpressVerif=false;
                    compteur=30;
                    valdash=0;
                    dashvalmax=false;
                    colorAppliqué=false;
                    fdown = this.keys.f.isUp;
                }
            } 
            
            if(player.body.velocity.y>0){
                isfallin = true
                player.anims.play("fall",true)
            }else{
                isfallin = false
            }

            if (Phaser.Input.Keyboard.JustDown(this.keys.espace)){
                if (player.body.blocked.down ) {
                    player.setVelocityY(-600);
                    player.anims.play("Jump",true)
                    injump=true
                }
            }  

            if (cursors.left.isDown || this.keys.q.isDown){ 
                if (FpressVerif==false){
                    player.setVelocityX(-200); 
                }
                if (indash==false){
                    player.direction="gauche"
                    if(isfallin == false && injump==false){
                    player.anims.play("WalkL", true)}
                }
            }

            else if (cursors.right.isDown || this.keys.d.isDown){ 
                if (FpressVerif==false ){
                    player.setVelocityX(200); 
                }
                if (indash==false){
                    player.direction="droite"
                    if(isfallin == false && injump==false){
                    player.anims.play("WalkR", true)}
                }
            }

            if (cursors.left.isUp && this.keys.q.isUp && cursors.right.isUp && this.keys.d.isUp && FpressVerif==false && isDownM==false){
                player.setVelocityX(0); 
                if(isfallin == false && injump==false){
                    player.anims.play("Immobile", true)
                }
            } 

        }
       
        

    </script>
</body>
</html>